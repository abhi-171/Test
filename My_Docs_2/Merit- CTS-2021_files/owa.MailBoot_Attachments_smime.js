self.scriptsLoaded = self.scriptsLoaded || {}; self.scriptProcessStart = self.scriptProcessStart || {}; self.scriptProcessStart['owa.MailBoot~Attachments~smime.js'] = (new Date()).getTime();(window.$wj=window.$wj||[]).push([[211],{10392:function(t,e,n){"use strict";var a=n(0),r=n(2876),o=n(218);e.a=function(t){return Object(a.__awaiter)(void 0,void 0,void 0,(function(){var e,n;return Object(a.__generator)(this,(function(a){switch(a.label){case 0:return(e={}).method="GET",e.headers=new Headers,e.headers.set(r.c,r.d),e.headers.set("Content-Type","application/json;charset=utf-8"),[4,fetch(t,e)];case 1:if(n=a.sent(),!Object(o.a)(n.status))throw new Error("The data package cannot be retrieved. StatusCode: "+n.status);return[4,n.text()];case 2:return[2,a.sent()]}}))}))}},10394:function(t,e,n){"use strict";var a=n(2994),r=n(4232),o=n(4230),i=n(7292),c=n(4228),s=n(1792),u=n(4667),h=n(4540),m=n(1675),d=n(188),l=n(1876);e.a=Object(d.action)("updateSmimeAttachment")((function(t,e,n,d,f){Object(i.a)(n,f)&&Object(h.a)(t.attachmentId);var I=Object(l.a)(n);if(n.AttachmentId=e,n.Name=d.Name||n.Name,n.Size=d.Size||n.Size,n.ContentType=d.ContentType||n.ContentType,n.__type=d.__type||n.__type,2===I?n.MimeContent=d.MimeContent:0===I&&(n.Content=d.Content),n.IsInline&&(n.ContentId=d.ContentId||n.ContentId),Object(u.a)([{attachmentId:e,attachment:n}],!1),t.attachmentId=e,Object(c.a)(t))Object(r.a)(t,1);else{var b=Object(m.a)(e);Object(s.h)(t,!1),Object(o.a)(t,0),Object(a.a)(t,b,!1,[])}}))},10395:function(t,e,n){"use strict";n.d(e,"a",(function(){return r}));var a=n(0);function r(t){return Object(a.__assign)({__type:"AttachmentId:#Exchange"},t)}},13633:function(t){t.exports=JSON.parse('{"a":"u8a","b":"v8a"}')},4594:function(t,e,n){"use strict";var a=n(0),r=function(t){function e(e,n,a){var r=t.call(this,e)||this;return r.errorCode=n,r.errorContext=a,r}return Object(a.__extends)(e,t),e}(Error);e.a=r},5264:function(t){t.exports=JSON.parse('{"a":"I8a"}')},5312:function(t,e,n){"use strict";n.d(e,"b",(function(){return a})),n.d(e,"c",(function(){return r})),n.d(e,"a",(function(){return o}));var a="application/octet-stream",r=1024,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="},7292:function(t,e,n){"use strict";function a(t,e){var n,a=null===(n=null==t?void 0:t.AttachmentId)||void 0===n?void 0:n.RootItemId;return a&&e&&a===e.Id}n.d(e,"a",(function(){return a}))},7294:function(t,e,n){"use strict";n.d(e,"a",(function(){return r}));var a=n(5312);function r(t){if(!t)return t;var e=t.toLowerCase().charCodeAt(0);if(e>=97&&e<=122&&-1===t.indexOf("#")&&-1===t.indexOf("-"))try{return atob(t)}catch(t){}for(var n="",r=0,o=function(){var e=t.charAt(r++);switch(e){case"\r":case"\n":return o();default:return e}};r<t.length;){var i=a.a.indexOf(o()),c=a.a.indexOf(o()),s=a.a.indexOf(o()),u=a.a.indexOf(o()),h=i<<2|c>>4,m=(15&c)<<4|s>>2,d=(3&s)<<6|u;n+=String.fromCharCode(h),64!=s&&(n+=String.fromCharCode(m)),64!=u&&(n+=String.fromCharCode(d))}return n}},7715:function(t,e,n){"use strict";var a=n(10387),r=n(7),o=n(1864),i=n(5577),c=n(34),s=n(0),u=function(t){if(!t)return t;if(0===t.indexOf("data:")){var e=t.indexOf(";base64,");return t.substr(e+";base64,".length)}return t},h=n(134),m=n(10394),d=n(7292),l=n(1675),f=n(4541),I=n(7294),b=n(5264),p=n(10395),O=n(28),w=n(374);var j=n(2447),v=n(10392),g=n(4594),A=n(214),S=n(2172),_=function(t,e){return Object(s.__awaiter)(void 0,void 0,void 0,(function(){var n,a,r,o;return Object(s.__generator)(this,(function(i){switch(i.label){case 0:n=new h.b("FetchAttachmentContent",{isCore:!0}),a=Object(S.a)(Object(s.__assign)({mailboxInfo:Object(A.d)()},t),0),i.label=1;case 1:return i.trys.push([1,3,,4]),[4,Object(v.a)(a+(e?"&asDataUri=true":""))];case 2:return r=i.sent(),n.end(),[2,r];case 3:throw o=i.sent(),c.d("SmimeTraceError: FetchAttachmentContent failed. URL: "+a),n.endWithError("ServerError",o),new g.a(o.message,11);case 4:return[2]}}))}))},C=n(13633),D=n(1953),y=n(1876),M=n(1726),x=n(1743);var E=function(){function t(t,e,n){var a=this;this.attachmentWellViewState=t,this.parentItemId=e,this.infoBar=n,this.downloadQueue=[],this.downloadFailures=[],this.deleteQueue=[],this.onFinishPromise=new Promise((function(t,e){a.onFinish=function(e){t(e)}}))}return t.prototype.enqueueSmimeAttachmentDownload=function(t,e){var n=this;void 0===e&&(e=null),t.map((function(t){var a={attachmentState:t,attachment:Object(l.a)(t.attachmentId),onAttachmentDownloaded:e};n.downloadQueue.push(a)})),this.startProcessIfNotStarted()},t.prototype.deleteSmimeAttachment=function(t,e){var n=1===t.attachmentType,a=n?0===t.status:0===t.ongoingAction;n||Object(D.A)(t,3,6),a&&this.currentDownloadItem&&this.currentDownloadItem.attachmentState.attachmentId!==t.attachmentId&&(c.g.info("Attachment: Removing attachment: TempId= "+t.attachmentId+" from S/MIME download queue"),this.removeRelatedItemFromDownloadQueue(t,this.downloadQueue)),this.deleteQueue.push({attachmentState:t,onAttachmentDeleted:e}),this.startProcessIfNotStarted()},t.prototype.startProcessIfNotStarted=function(){this.isInProgress||(this.datapoint=new h.b("SmimeAttachmentQueueManager"),this.isInProgress=!0,this.processNextAttachment())},t.prototype.processNextAttachment=function(){var t;return Object(s.__awaiter)(this,void 0,void 0,(function(){var e,n,a,r,o,i,b,v,g,A,S,C,D,E,F,Q,N,P,T,U,W,B;return Object(s.__generator)(this,(function(R){switch(R.label){case 0:return 0==this.deleteQueue.length?[3,1]:(e=this.deleteQueue.shift(),o=e.attachmentState,n=e.onAttachmentDeleted,a=Object(l.a)(o.attachmentId),Object(f.a)(this.attachmentWellViewState,o),null==n||n(this.parentItemId,a.model.AttachmentId,a.model),this.processNextAttachment(),[3,19]);case 1:if(0===this.downloadQueue.length)return[3,18];this.currentDownloadItem=this.downloadQueue.shift(),r=this.currentDownloadItem,o=r.attachmentState,i=r.attachment,b=r.onAttachmentDownloaded,v=Object(y.a)(i.model),g=i.model,A=void 0,R.label=2;case 2:return R.trys.push([2,15,16,17]),S=this.getAttachmentId(i.model,this.parentItemId),A=Object(s.__assign)({},g),2!==v?[3,9]:(null===(t=(C=g).Item)||void 0===t?void 0:t.MimeContent)?(A.MimeContent=Object(I.a)(C.Item.MimeContent.Value),[3,8]):[3,3];case 3:return g.MimeContent?[3,8]:(null==S?void 0:S.Id)?[4,_(S)]:[3,5];case 4:return E=R.sent(),[3,7];case 5:return[4,(V={itemId:this.getItemId(i.model)},void 0===V.itemId||V.itemId.__type||(V.itemId=Object(w.a)(V.itemId)),Object(O.a)("GetMime",V,q))];case 6:E=R.sent(),R.label=7;case 7:D=E,A.__type=x.b,A.MimeContent=D,Object(h.r)("SmimeAttachmentDownloadDatapoint",{isMailDownload:!0},{isCore:!0}),R.label=8;case 8:return[3,14];case 9:return 0!==v?[3,13]:g.Content?[3,11]:[4,_(S,!0)];case 10:return F=R.sent(),A.__type=x.a,A.Content=u(F),Object(h.r)("SmimeAttachmentDownloadDatapoint",{isFileDownload:!0},{isCore:!0}),[3,12];case 11:A=Object(s.__assign)({},g),R.label=12;case 12:return[3,14];case 13:throw 1===v?new Error("S/MIME: Unsupported reference attachment"):new Error("S/MIME: Unsupported attachment type");case 14:return Q=g.AttachmentId,Object(M.d)(g)&&Object(d.a)(g,this.parentItemId)||(Q=Object(s.__assign)(Object(s.__assign)({},Object(p.a)({Id:Object(j.e)()})),{mailboxInfo:this.parentItemId.mailboxInfo})),null==b||b(i.model),Object(m.a)(o,Q,g,A,this.parentItemId),[3,17];case 15:return"S/MIME: Unsupported reference attachment"!==(N=R.sent()).message&&c.d("SmimeTraceError: "+N.message),P=this.currentDownloadItem.attachment.model.IsInline,T=this.currentDownloadItem.attachment,U=T.attachmentClass,W=T.type,Object(h.r)("SmimeAttachmentDownloadDatapoint",{attachmentClass:U,type:W,IsInline:P,isError:!0,message:N.message},{isCore:!0}),B={item:this.currentDownloadItem,reason:"S/MIME: Unsupported reference attachment"===N.message?1:0},this.downloadFailures.push(B),[3,17];case 16:return this.processNextAttachment(),[7];case 17:return[3,19];case 18:this.finishProcess(),R.label=19;case 19:return[2]}var V,q}))}))},t.prototype.finishProcess=function(){var t=this.currentDownloadItem&&this.currentDownloadItem.attachmentState?this.currentDownloadItem.attachmentState.attachmentId:null;c.g.info("Attachment: SmimeAttachmentQueueManager: finishProcess"),this.isInProgress=!1,this.currentDownloadItem=null,this.onFinish(t),this.datapoint.end(),this.datapoint=null,this.downloadFailures.length&&this.removeFromAttachmentWellAndShowError(this.downloadFailures),this.downloadFailures=[]},t.prototype.removeRelatedItemFromDownloadQueue=function(t,e){for(var n=0;n<e.length;n++){e[n].attachmentState.attachmentId===t.attachmentId&&e.splice(n,1)}},t.prototype.removeFromAttachmentWellAndShowError=function(t){var e=this,n=[],a=[];t.map((function(t){var r=t.item.attachment&&t.item.attachment.model.Name;1===t.reason?n.push(r):0===t.reason&&a.push(r),Object(f.a)(e.attachmentWellViewState,t.item.attachmentState)})),n.length>0&&Object(o.a)(this.infoBar,"ErrorSmimeHasCloudOrUriAttachments",[Object(r.c)(Object(r.b)(b.a),n.join(", "))]),a.length>3?Object(o.a)(this.infoBar,"ErrorAttachmentDownloadFailedMultipleFiles",[Object(r.c)(Object(r.b)(C.b),a.length)]):a.length>0&&Object(o.a)(this.infoBar,"ErrorAttachmentDownloadFailed",[Object(r.c)(Object(r.b)(C.a),a.join(", "))])},t.prototype.getAttachmentId=function(t,e){var n,a=t,r=a.AttachmentIdToAttach&&Object(p.a)({Id:a.AttachmentIdToAttach});switch(t.__type){case x.b:case x.c:n=r;break;default:n=r||t.AttachmentId}return Object(s.__assign)(Object(s.__assign)({},n),{mailboxInfo:e.mailboxInfo})},t.prototype.getItemId=function(t){var e=t;return e.Item?e.Item.ItemId:e.ItemId},t}();n.d(e,"a",(function(){return Q})),n.d(e,"b",(function(){return N}));var F={};function Q(t,e,n,c,s){return e?P(t,e,n).enqueueSmimeAttachmentDownload(c,s):(Object(i.a)(n),Object(o.a)(n,"WarningFilesCanNotBeAttachedGenericError",[Object(r.b)(a.a)]),[])}function N(t,e,n,a,r){P(t,n,a).deleteSmimeAttachment(e,r)}function P(t,e,n){var a=F[e.Id];return a||(c.g.info("Creating SmimeAttachmentQueueManager"),a=function(t,e,n){return new E(t,e,n)}(t,e,n),F[e.Id]=a,a.onFinishPromise.then((function(){c.g.info("Deleting SmimeAttachmentQueueManager"),delete F[e.Id]}))),a}}}]);
//# sourceMappingURL=owa.MailBoot~Attachments~smime.js.map
self.scriptsLoaded['owa.MailBoot~Attachments~smime.js'] = 1; self.scriptProcessEnd = self.scriptProcessEnd || {}; self.scriptProcessEnd['owa.MailBoot~Attachments~smime.js'] = (new Date()).getTime();